<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Estudos - PCPR</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        /* Classes utilit√°rias */
        .card { border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: transform 0.2s; }
        .card:hover { transform: translateY(-2px); }
        
        /* Anima√ß√£o do Modal */
        .modal-animate { animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* Scroll customizado */
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e0; border-radius: 3px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #a0aec0; }
        
        /* Scroll Dark Mode */
        .dark .custom-scroll::-webkit-scrollbar-track { background: #374151; }
        .dark .custom-scroll::-webkit-scrollbar-thumb { background: #4b5563; }
        
        /* Remove setas do input number */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    </style>
</head>
<body class="p-6 min-h-screen flex flex-col transition-colors duration-300 bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-100">

    <header class="mb-8 flex flex-col md:flex-row justify-between items-center bg-white dark:bg-gray-800 p-4 rounded-lg shadow-sm gap-4 transition-colors duration-300">
        <div class="flex items-center gap-3 w-full md:w-auto">
            <div class="bg-blue-600 text-white p-3 rounded-full shadow-lg">
                <i class="fas fa-shield-alt text-2xl"></i>
            </div>
            <div>
                <h1 class="text-2xl font-bold text-gray-800 dark:text-white">Painel PCPR</h1>
                <p class="text-gray-500 dark:text-gray-400 text-sm">Gest√£o de Estudos e Revis√£o Ativa</p>
            </div>
        </div>
        
        <button onclick="toggleTheme()" id="btnThemeToggle" class="p-3 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition focus:outline-none border dark:border-gray-600" title="Alternar Tema">
            <!-- √çcone injetado via JS -->
            <i class="fas fa-moon"></i>
        </button>
    </header>

    <!-- Card de Alertas de Revis√£o -->
    <div id="cardAlertasRevisao" class="hidden mb-8 bg-yellow-50 dark:bg-yellow-900/20 border-l-4 border-yellow-500 p-4 rounded-md shadow-md animate-pulse transition-colors duration-300">
        <div class="flex items-start">
            <div class="flex-shrink-0">
                <i class="fas fa-exclamation-triangle text-yellow-500 text-xl mt-1"></i>
            </div>
            <div class="ml-3 w-full">
                <h3 class="text-lg leading-6 font-medium text-yellow-800 dark:text-yellow-400">Ciclo de Revis√£o Ativa Detectado</h3>
                <p class="text-sm text-yellow-700 dark:text-yellow-300 mt-1">
                    Com base no seu cronograma de hoje, voc√™ precisa revisar estes assuntos antes de avan√ßar:
                </p>
                <div id="listaRevisoesPendentes" class="mt-4 space-y-3">
                    <!-- Injetado via JS -->
                </div>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
        
        <!-- Cart√£o do Timer (POMODORO) -->
        <div class="card p-6 col-span-1 text-center bg-gray-900 text-white border-t-4 border-green-500 relative overflow-hidden dark:bg-black dark:border-green-600 transition-colors duration-300">
            <div class="absolute top-0 right-0 p-4 opacity-10">
                <i class="fas fa-stopwatch text-9xl"></i>
            </div>
            
            <div class="flex justify-between items-center mb-4 relative z-10">
                <h2 class="text-xl font-bold text-white">üçÖ Pomodoro</h2>
                <button onclick="abrirConfigPomodoro()" class="text-gray-400 hover:text-white transition" title="Configurar Timer">
                    <i class="fas fa-cog text-xl"></i>
                </button>
            </div>

            <!-- Bot√µes de Modo -->
            <div class="flex justify-center gap-2 mb-4 relative z-10">
                <button onclick="mudarModoPomodoro('focus')" id="btnModeFocus" class="px-3 py-1 rounded-full text-xs font-bold bg-green-600 text-white border border-green-500 transition shadow-lg transform scale-105">Foco</button>
                <button onclick="mudarModoPomodoro('short')" id="btnModeShort" class="px-3 py-1 rounded-full text-xs font-bold bg-gray-700 text-gray-300 border border-gray-600 hover:bg-gray-600 transition">Curta</button>
                <button onclick="mudarModoPomodoro('long')" id="btnModeLong" class="px-3 py-1 rounded-full text-xs font-bold bg-gray-700 text-gray-300 border border-gray-600 hover:bg-gray-600 transition">Longa</button>
            </div>
            
            <select id="selectMateriaEstudo" class="w-full p-2 mb-4 text-gray-800 bg-white rounded border-none focus:ring-2 focus:ring-green-400 relative z-10 cursor-pointer dark:bg-gray-800 dark:text-white transition-colors duration-300">
                <option value="">Selecione o que vai estudar...</option>
            </select>

            <div class="text-7xl font-mono mb-6 font-bold tracking-wider relative z-10 text-white transition-all" id="displayTempo">25:00</div>
            
            <div class="flex justify-center gap-4 relative z-10">
                <button onclick="iniciarTimer()" id="btnStart" class="bg-green-500 p-4 rounded-full w-14 h-14 flex items-center justify-center hover:bg-green-600 text-white shadow-lg transition transform hover:scale-110 active:scale-95" title="Iniciar">
                    <i class="fas fa-play" id="iconPlayPause"></i>
                </button>
                <button onclick="resetarTimer()" class="bg-gray-600 p-4 rounded-full w-14 h-14 flex items-center justify-center hover:bg-gray-500 text-white shadow-lg transition transform hover:scale-110 active:scale-95" title="Reiniciar">
                    <i class="fas fa-undo"></i>
                </button>
                <button onclick="pararESalvar()" class="bg-red-500 p-4 rounded-full w-14 h-14 flex items-center justify-center hover:bg-red-600 text-white shadow-lg transition transform hover:scale-110 active:scale-95" title="Salvar e Parar (Interromper)">
                    <i class="fas fa-save"></i>
                </button>
            </div>
            <p class="mt-4 text-xs text-gray-400 relative z-10" id="statusTimer">Pronto para focar.</p>
        </div>

        <!-- Cart√£o de Estat√≠sticas -->
        <div class="card p-6 col-span-1 border-t-4 border-purple-500 flex flex-col justify-center bg-white dark:bg-gray-800 dark:border-purple-600 transition-colors duration-300">
            <h2 class="text-xl font-bold mb-4 text-gray-700 dark:text-gray-200"><i class="fas fa-chart-pie text-purple-500 mr-2"></i>Estat√≠sticas</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <!-- Tempo Total -->
                <div class="flex items-center p-3 bg-blue-50 dark:bg-blue-900/30 rounded-lg sm:col-span-2 transition-colors duration-300">
                    <div class="p-3 bg-blue-200 dark:bg-blue-800 rounded-full text-blue-600 dark:text-blue-200 mr-4 transition-colors duration-300">
                        <i class="fas fa-clock text-xl"></i>
                    </div>
                    <div>
                        <p class="text-xs text-gray-500 dark:text-gray-400 font-medium uppercase">Tempo Total</p>
                        <p class="text-xl font-bold text-gray-800 dark:text-white" id="totalHoras">0h 00m</p>
                    </div>
                </div>
                
                <!-- Assuntos Cadastrados -->
                <div class="flex items-center p-3 bg-green-50 dark:bg-green-900/30 rounded-lg transition-colors duration-300">
                    <div class="p-3 bg-green-200 dark:bg-green-800 rounded-full text-green-600 dark:text-green-200 mr-3 transition-colors duration-300">
                        <i class="fas fa-list-ol text-lg"></i>
                    </div>
                    <div>
                        <p class="text-xs text-gray-500 dark:text-gray-400 font-medium uppercase">Assuntos</p>
                        <p class="text-xl font-bold text-gray-800 dark:text-white" id="totalAssuntos">0</p>
                    </div>
                </div>

                <!-- Revis√µes Pendentes -->
                <div class="flex items-center p-3 bg-red-50 dark:bg-red-900/30 rounded-lg transition-colors duration-300">
                    <div class="p-3 bg-red-200 dark:bg-red-800 rounded-full text-red-600 dark:text-red-200 mr-3 transition-colors duration-300">
                        <i class="fas fa-bell text-lg"></i>
                    </div>
                    <div>
                        <p class="text-xs text-gray-500 dark:text-gray-400 font-medium uppercase">Revis√µes</p>
                        <p class="text-xl font-bold text-red-600 dark:text-red-400" id="totalRevisoesPendentes">0</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Novo Card: Cronograma Semanal -->
    <div class="card p-6 mb-8 border-t-4 border-orange-500 bg-white dark:bg-gray-800 dark:border-orange-600 transition-colors duration-300">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold text-gray-700 dark:text-gray-200"><i class="fas fa-calendar-alt text-orange-500 mr-2"></i> Cronograma Semanal</h2>
            <div class="text-sm text-gray-500 dark:text-gray-400">Hoje √©: <span id="diaDaSemanaDisplay" class="font-bold text-blue-600 dark:text-blue-400">...</span></div>
            <button onclick="resetarCronograma()" class="text-xs text-gray-400 hover:text-orange-500 transition" title="Restaurar padr√£o"><i class="fas fa-undo"></i> Resetar</button>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-7 gap-4" id="gridCronograma">
            <!-- Gerado via JS -->
        </div>
    </div>

    <!-- Tabela -->
    <div class="flex-grow">
        <h2 class="text-xl font-bold mb-4 text-gray-800 dark:text-gray-200 pl-2 border-l-4 border-gray-800 dark:border-gray-200 transition-colors duration-300">üìã Conte√∫do Program√°tico</h2>
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden transition-colors duration-300">
            <div class="overflow-x-auto">
                <table class="min-w-full leading-normal">
                    <thead>
                        <tr>
                            <th class="px-5 py-3 border-b-2 border-gray-200 dark:border-gray-700 bg-gray-100 dark:bg-gray-700 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider transition-colors duration-300">Assunto</th>
                            <th class="px-5 py-3 border-b-2 border-gray-200 dark:border-gray-700 bg-gray-100 dark:bg-gray-700 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider w-48 transition-colors duration-300">Relev√¢ncia (Edit√°vel)</th>
                            <th class="px-5 py-3 border-b-2 border-gray-200 dark:border-gray-700 bg-gray-100 dark:bg-gray-700 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider transition-colors duration-300">Tempo Estudado</th>
                            <th class="px-5 py-3 border-b-2 border-gray-200 dark:border-gray-700 bg-gray-100 dark:bg-gray-700 text-center text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider transition-colors duration-300">A√ß√£o</th>
                        </tr>
                    </thead>
                    <tbody id="tabelaCorpo">
                        <!-- Linhas geradas via JS -->
                    </tbody>
                </table>
            </div>
            <div id="emptyState" class="hidden p-8 text-center text-gray-500 dark:text-gray-400 transition-colors duration-300">
                <i class="fas fa-clipboard-list text-4xl mb-3 text-gray-300 dark:text-gray-600"></i>
                <p>Nenhum assunto cadastrado ainda.</p>
            </div>
        </div>
    </div>

    <!-- Modal Customizado (Gen√©rico) -->
    <div id="customModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-50 modal-animate backdrop-blur-sm">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md mx-4 overflow-hidden flex flex-col max-h-[90vh] transition-colors duration-300">
            <div class="p-4 border-b dark:border-gray-700 flex items-center gap-2" id="modalHeader">
                <h3 class="text-lg font-bold text-gray-800 dark:text-gray-100" id="modalTitle">T√≠tulo</h3>
            </div>
            <div class="p-6 overflow-y-auto custom-scroll flex-grow">
                <div id="modalContentWrapper">
                    <p class="text-gray-600 dark:text-gray-300 text-base mb-2" id="modalMessage">Mensagem aqui.</p>
                    
                    <!-- Input para Links -->
                    <div id="modalInputContainer" class="hidden mb-4">
                        <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-1">Cole o link das quest√µes aqui:</label>
                        <input type="text" id="modalInputLink" class="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white transition-colors duration-300" placeholder="https://...">
                    </div>

                    <!-- Configura√ß√µes Pomodoro -->
                    <div id="modalPomodoroConfig" class="hidden space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Tempo de Foco (min):</label>
                            <input type="number" id="cfgFocus" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Pausa Curta (min):</label>
                            <input type="number" id="cfgShort" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Pausa Longa (min):</label>
                            <input type="number" id="cfgLong" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        </div>
                    </div>

                    <!-- Conte√∫do de Jurisprud√™ncia -->
                    <div id="modalJurisContent" class="hidden space-y-4"></div>
                </div>
            </div>
            <div class="p-4 bg-gray-50 dark:bg-gray-700 flex justify-end gap-3 border-t dark:border-gray-600 transition-colors duration-300" id="modalButtons">
                <!-- Bot√µes injetados via JS -->
            </div>
        </div>
    </div>

    <script>
        // --- BASE DE DADOS DE JURISPRUD√äNCIA ---
        const BANCO_JURISPRUDENCIA = {
            "CONSTITUCIONAL": [
                { t: "Inviolabilidade de Domic√≠lio (Tema 280)", p: "STF", r: "Entrada for√ßada exige fundadas raz√µes, devidamente justificadas a posteriori." },
                { t: "Intimidade vs Interesse P√∫blico (Tema 786)", p: "STF", r: "Divulga√ß√£o de fatos de interesse p√∫blico n√£o gera dano moral autom√°tico." },
                { t: "Direito de Reuni√£o", p: "STF", r: "Independe de autoriza√ß√£o, mas exige pr√©vio aviso √† autoridade competente." },
                { t: "Liberdade de Express√£o", p: "STF", r: "N√£o √© absoluta; n√£o protege discurso de √≥dio nem apologia ao crime." },
                { t: "Seguran√ßa P√∫blica - Pol√≠cia Civil", p: "STF", r: "Exerce fun√ß√£o de pol√≠cia judici√°ria, n√£o podendo ser esvaziada por outros √≥rg√£os." },
                { t: "Guardas Municipais", p: "STF", r: "N√£o t√™m atribui√ß√£o investigativa ampla, apenas prote√ß√£o de bens e servi√ßos." },
                { t: "Direitos Pol√≠ticos", p: "STF", r: "Condena√ß√£o criminal transitada em julgado gera suspens√£o autom√°tica (art. 15, III, CF)." }
            ],
            "ADMINISTRATIVO": [
                { t: "Princ√≠pio da Legalidade", p: "STF/STJ", r: "Princ√≠pio da legalidade estrita para a Administra√ß√£o P√∫blica." },
                { t: "Improbidade Administrativa", p: "STF", r: "Viola√ß√£o aos princ√≠pios do art. 37 pode configurar improbidade (contexto pr√©-reforma)." },
                { t: "Acumula√ß√£o de Cargos", p: "STF", r: "Devolu√ß√£o de valores por acumula√ß√£o il√≠cita somente se comprovada m√°-f√©." },
                { t: "Est√°gio Probat√≥rio", p: "STF", r: "Exonera√ß√£o n√£o dispensa contradit√≥rio e ampla defesa." },
                { t: "Poder de Pol√≠cia", p: "STJ", r: "Indeleg√°vel a pessoas jur√≠dicas de direito privado, salvo atos materiais/fiscalizat√≥rios." },
                { t: "Multas Administrativas", p: "STF", r: "N√£o podem ter car√°ter confiscat√≥rio." },
                { t: "Resp. Civil do Estado (Tema 940)", p: "STF", r: "Objetiva do Estado; Direito de regresso contra agente exige dolo ou culpa." },
                { t: "Resp. Civil por Omiss√£o", p: "STF", r: "Subjetiva (necessidade de prova de culpa/falta do servi√ßo)." }
            ],
            "PENAL": [
                { t: "Teoria do Crime", p: "STF/STJ", r: "Crime exige tipicidade + ilicitude + culpabilidade." },
                { t: "Princ√≠pio da Insignific√¢ncia", p: "STF", r: "Requisitos: m√≠nima ofensividade, nenhuma periculosidade, reduzida reprovabilidade, inexpressividade da les√£o." },
                { t: "Erro de Tipo", p: "STJ", r: "Exclui dolo, podendo gerar culpa se prevista." },
                { t: "Erro de Proibi√ß√£o", p: "STF", r: "Inevit√°vel exclui culpabilidade; evit√°vel reduz a pena." },
                { t: "Concurso de Pessoas", p: "STJ", r: "Participa√ß√£o de menor import√¢ncia gera redu√ß√£o obrigat√≥ria de pena." },
                { t: "Dom√≠nio do Fato", p: "STF", r: "Teoria aplicada com cautela, n√£o √© autom√°tica para cargos de chefia." },
                { t: "Corrup√ß√£o Passiva", p: "STF", r: "Crime formal: independe do efetivo recebimento da vantagem." },
                { t: "Peculato", p: "STJ", r: "Admite forma culposa." }
            ],
            "PROCESSUAL": [
                { t: "Inqu√©rito Policial", p: "STF", r: "Procedimento administrativo, inquisitivo e dispens√°vel. Sem contradit√≥rio pleno." },
                { t: "Prova Il√≠cita", p: "STF", r: "Inadmiss√≠vel, salvo teoria da fonte independente." },
                { t: "Cadeia de Cust√≥dia", p: "STF", r: "Requisito de validade da prova (tema muito cobrado)." },
                { t: "Pris√£o em Flagrante", p: "STF", r: "N√£o exige mandado judicial." },
                { t: "Flagrante Preparado", p: "STJ", r: "Configura crime imposs√≠vel (S√∫mula 145)." },
                { t: "Pris√£o Preventiva", p: "STF/STJ", r: "Exige fundamenta√ß√£o concreta. Gravidade abstrata do crime n√£o basta." },
                { t: "Audi√™ncia de Cust√≥dia", p: "STF", r: "Obrigat√≥ria." },
                { t: "Pris√£o Tempor√°ria", p: "STF", r: "Somente para crimes expressamente previstos em lei." },
                { t: "Prazo Tempor√°ria", p: "STJ", r: "Taxativo, n√£o pode ser prorrogado fora das hip√≥teses legais." }
            ],
            "LEGISLACAO": [
                { t: "Lei de Drogas - Usu√°rio", p: "STF", r: "Usu√°rio n√£o comete crime hediondo." },
                { t: "Tr√°fico Privilegiado (Tema 712)", p: "STF", r: "N√£o √© considerado hediondo." },
                { t: "Crimes Hediondos - Regime", p: "STF", r: "Regime inicial n√£o √© automaticamente fechado. Progress√£o observa individualiza√ß√£o." },
                { t: "Abuso de Autoridade", p: "STF", r: "Exige dolo espec√≠fico (finalidade de prejudicar, beneficiar ou agir por capricho)." },
                { t: "Hermen√™utica no Abuso", p: "STJ", r: "Erro de interpreta√ß√£o razo√°vel da lei n√£o configura crime." },
                { t: "Estatuto do Desarmamento", p: "STF", r: "Porte ilegal √© crime de perigo abstrato." },
                { t: "Numera√ß√£o Raspada", p: "STJ", r: "Crime aut√¥nomo (equiparado)." },
                { t: "Intercepta√ß√£o Telef√¥nica", p: "STF", r: "Necess√°ria decis√£o fundamentada. Prazo inicial 15 dias, prorrog√°vel." },
                { t: "Prova Emprestada", p: "STJ", r: "V√°lida, se respeitado o contradit√≥rio." },
                { t: "Pacote Anticrime", p: "STF", r: "Juiz das garantias v√°lido (suspenso). ANPP retroage se mais ben√©fico." }
            ],
            "ESTATUTO": [
                { t: "Regime Estatut√°rio", p: "STF", r: "N√£o afasta aplica√ß√£o dos princ√≠pios constitucionais." },
                { t: "Processo Administrativo (PAD)", p: "STJ", r: "Exige contradit√≥rio e ampla defesa." },
                { t: "Independ√™ncia das Inst√¢ncias", p: "STF", r: "San√ß√µes administrativas n√£o afastam responsabilidade penal." }
            ]
        };

        // --- BANCO DE LINKS PADR√ÉO (Mesclado com user data) ---
        const LINKS_PADRAO = {
            "Inqu√©rito policial; notitia criminis": "https://questoes.grancursosonline.com.br/aluno/filtro/concursos?tiposProva=1&carreira=29&assunto=406608%2C414132%2C414133%2C414134%2C414135%2C414136%2C406609%2C406610%2C406611%2C421025%2C421026%2C421027%2C421028%2C421029%2C421030%2C421031%2C421032%2C421035%2C421036%2C421037%2C421038%2C421039%2C421040%2C421041%2C421042%2C421043%2C421044%2C421045%2C421046%2C421047%2C421048%2C421049%2C421050%2C421052%2C421053%2C421054%2C421150&desatualizada=0&anulada=0"
        };

        // --- Dados Iniciais (Editais) ---
        const EDITAL_PORTUGUES = [
            { assunto: "Apreens√£o do significado global dos textos", relevancia: 75 },
            { assunto: "Estabelecimento de rela√ß√µes intratextuais e intertextuais", relevancia: 75 },
            { assunto: "Identifica√ß√£o de ideias principais/secund√°rias e rela√ß√µes", relevancia: 75 },
            { assunto: "Organiza√ß√£o argumentativa: tese e argumentos", relevancia: 75 },
            { assunto: "Dedu√ß√£o de ideias impl√≠citas e infer√™ncia de sentidos", relevancia: 75 },
            { assunto: "Reconhecimento de diferentes 'vozes' no texto", relevancia: 75 },
            { assunto: "Posi√ß√£o do autor (fato/opini√£o)", relevancia: 75 },
            { assunto: "Significado de palavras em contextos", relevancia: 75 },
            { assunto: "Recursos coesivos (express√µes, pronomes)", relevancia: 75 },
            { assunto: "Rela√ß√µes estruturais e sem√¢nticas entre frases", relevancia: 75 },
            { assunto: "Compreens√£o de textos complexos", relevancia: 75 },
            { assunto: "Ambiguidade, par√°frase, sinon√≠mia e anton√≠mia", relevancia: 75 },
            { assunto: "Reconhecimento da fun√ß√£o de recursos gramaticais", relevancia: 11 },
            { assunto: "Dom√≠nio da norma padr√£o (gram√°tica, ortografia)", relevancia: 11 },
            { assunto: "Variedades lingu√≠sticas", relevancia: 0 },
            { assunto: "Recursos verbais e n√£o verbais (charges, gr√°ficos)", relevancia: 0 }
        ];

        const EDITAL_INFORMATICA = [
            { assunto: "Sistema Operacional Linux (Ubuntu 14+)", relevancia: 35 },
            { assunto: "Opera√ß√£o com arquivos, Internet e Redes no Linux", relevancia: 35 },
            { assunto: "Planilhas Eletr√¥nicas (LibreOffice Calc)", relevancia: 24 },
            { assunto: "Editor de Texto (LibreOffice Writer)", relevancia: 21 },
            { assunto: "Funcionamento de perif√©ricos (impressoras/digitalizadoras)", relevancia: 0 },
            { assunto: "Conceitos de Internet, Intranet e gest√£o de info", relevancia: 0 }
        ];

        const EDITAL_EXECUTIVO = [
            { assunto: "Const. PR: Adm. P√∫blica (T√≠tulo II) e Poder Executivo (T√≠tulo III)", relevancia: 0 },
            { assunto: "Lei Estadual n¬∫ 8.485/1987: Artigos 1¬∫ ao 43", relevancia: 0 }
        ];

        const EDITAL_PROC_PENAL = [
            { assunto: "Pris√£o em flagrante", relevancia: 24 },
            { assunto: "Pris√£o preventiva", relevancia: 24 },
            { assunto: "Pris√£o tempor√°ria (Lei n.¬∞ 7.960/1989)", relevancia: 24 },
            { assunto: "Inqu√©rito policial; notitia criminis", relevancia: 18 },
            { assunto: "A√ß√£o penal: esp√©cies", relevancia: 0 },
            { assunto: "Jurisdi√ß√£o e compet√™ncia", relevancia: 0 },
            { assunto: "Prova (artigos 158 a 184 do CPP)", relevancia: 0 }
        ];

        const EDITAL_PENAL = [
            { assunto: "Infra√ß√£o penal: elementos, esp√©cies", relevancia: 49 },
            { assunto: "Sujeito ativo e sujeito passivo da infra√ß√£o penal", relevancia: 49 },
            { assunto: "Tipicidade, ilicitude, culpabilidade, punibilidade", relevancia: 49 },
            { assunto: "Erro de tipo e erro de proibi√ß√£o", relevancia: 49 },
            { assunto: "Imputabilidade penal", relevancia: 49 },
            { assunto: "Concurso de pessoas", relevancia: 49 },
            { assunto: "Crimes contra a administra√ß√£o p√∫blica", relevancia: 24 },
            { assunto: "Crimes contra o patrim√¥nio", relevancia: 18 },
            { assunto: "Crimes contra a pessoa", relevancia: 0 }
        ];

        const EDITAL_ADMINISTRATIVO = [
            { assunto: "Poderes administrativos: hier√°rquico, disciplinar, regulamentar, pol√≠cia", relevancia: 28 },
            { assunto: "Controle e responsabiliza√ß√£o da administra√ß√£o", relevancia: 21 },
            { assunto: "Organiza√ß√£o administrativa da Uni√£o: administra√ß√£o direta e indireta", relevancia: 16 },
            { assunto: "Estado, governo e administra√ß√£o p√∫blica: conceitos, elementos, poderes", relevancia: 15 },
            { assunto: "Agentes p√∫blicos: esp√©cies, classifica√ß√£o, poderes, deveres, regime jur√≠dico", relevancia: 0 },
            { assunto: "Servi√ßos p√∫blicos: conceito, classifica√ß√£o, regulamenta√ß√£o", relevancia: 0 }
        ];

        const EDITAL_CONSTITUCIONAL = [
            { assunto: "Direitos e deveres fundamentais (individuais, coletivos, sociais)", relevancia: 47 },
            { assunto: "Defesa do Estado e das institui√ß√µes democr√°ticas (Seguran√ßa P√∫blica)", relevancia: 18 },
            { assunto: "Declara√ß√£o Universal dos Direitos Humanos (ONU ‚Äì 1948)", relevancia: 18 },
            { assunto: "Poder Legislativo: fundamento e atribui√ß√µes", relevancia: 0 },
            { assunto: "Poder Executivo: forma de governo, atribui√ß√µes do Presidente", relevancia: 0 },
            { assunto: "Ordem social: seguridade, educa√ß√£o, cultura, meio ambiente", relevancia: 0 }
        ];

        const EDITAL_RLM = [
            { assunto: "Resolu√ß√£o de problemas: n√∫meros reais, conjuntos, contagem, porcentagem", relevancia: 33 },
            { assunto: "Problemas de racioc√≠nio l√≥gico: proposi√ß√µes, conectivos, equival√™ncia", relevancia: 26 },
            { assunto: "Compreens√£o de estruturas l√≥gicas", relevancia: 26 },
            { assunto: "Sistemas, equa√ß√µes e regra de tr√™s", relevancia: 17 },
            { assunto: "Semelhan√ßa e rela√ß√µes m√©tricas no tri√¢ngulo ret√¢ngulo", relevancia: 0 },
            { assunto: "√Årea, volume e capacidade", relevancia: 0 },
            { assunto: "Medidas de tend√™ncia central, tabelas e gr√°ficos", relevancia: 0 },
            { assunto: "L√≥gica de argumenta√ß√£o: analogias, infer√™ncias, dedu√ß√µes", relevancia: 0 },
            { assunto: "Diagramas l√≥gicos", relevancia: 0 },
            { assunto: "Princ√≠pios de contagem e probabilidade", relevancia: 0 }
        ];

        const EDITAL_LEGISLACAO_ESPECIAL = [
            { assunto: "Tr√°fico il√≠cito e uso indevido de drogas (Lei n¬∫ 11.343/2006)", relevancia: 23 },
            { assunto: "Estatuto do desarmamento (Lei n¬∫ 10.826/2003)", relevancia: 21 },
            { assunto: "Abuso de Autoridade (Lei n¬∫ 13.869/2019)", relevancia: 7 },
            { assunto: "Crimes de tortura (Lei n¬∫ 9.455/1997)", relevancia: 7 },
            { assunto: "Crimes hediondos (Lei n¬∫ 8.072/1990)", relevancia: 0 },
            { assunto: "Crimes resultantes de preconceitos de ra√ßa ou de cor (Lei n¬∫ 7.716/1989)", relevancia: 0 },
            { assunto: "Estatuto da Crian√ßa e do Adolescente (Lei n¬∫ 8.069/1990)", relevancia: 0 },
            { assunto: "Crimes previstos no C√≥digo de prote√ß√£o e defesa do consumidor (Lei n¬∫ 8.078/1990)", relevancia: 0 },
            { assunto: "Crimes contra o meio ambiente (Lei n¬∫ 9.605/1998)", relevancia: 0 },
            { assunto: "Juizados especiais (Lei n¬∫ 9.099/1995 e Lei n¬∫ 10.259/2001)", relevancia: 0 },
            { assunto: "Crimes previstos no C√≥digo de Tr√¢nsito Brasileiro (Lei n¬∫ 9.503/1997)", relevancia: 0 },
            { assunto: "Intercepta√ß√£o telef√¥nica (Lei n¬∫ 9.296/1996)", relevancia: 0 },
            { assunto: "Lei n¬∫ 12.830/2013 (Investiga√ß√£o Criminal)", relevancia: 0 },
            { assunto: "Pacote Anti-Crime (Lei n¬∫ 13.964/2019)", relevancia: 0 }
        ];

        const TODOS_EDITAIS = [
            ...EDITAL_PORTUGUES.map(i => ({...i, materia: 'L√≠ngua Portuguesa'})),
            ...EDITAL_INFORMATICA.map(i => ({...i, materia: 'Inform√°tica'})),
            ...EDITAL_EXECUTIVO.map(i => ({...i, materia: 'Estrutura do Executivo PR'})),
            ...EDITAL_PROC_PENAL.map(i => ({...i, materia: 'Direito Processual Penal'})),
            ...EDITAL_PENAL.map(i => ({...i, materia: 'Direito Penal'})),
            ...EDITAL_ADMINISTRATIVO.map(i => ({...i, materia: 'Direito Administrativo'})),
            ...EDITAL_CONSTITUCIONAL.map(i => ({...i, materia: 'Direito Constitucional'})),
            ...EDITAL_RLM.map(i => ({...i, materia: 'Racioc√≠nio L√≥gico'})),
            ...EDITAL_LEGISLACAO_ESPECIAL.map(i => ({...i, materia: 'Legisla√ß√£o Penal Especial'}))
        ];

        // --- L√≥gica do Sistema ---

        let dados = JSON.parse(localStorage.getItem('dadosPCPR')) || [];
        // Hist√≥rico de Estudos: Array de objetos { idMateria, data, tempo, revisado: false }
        let historicoEstudos = JSON.parse(localStorage.getItem('historicoEstudosPCPR')) || [];
        let pomodoroConfig = JSON.parse(localStorage.getItem('pomodoroConfig')) || { focus: 25, short: 5, long: 15 };
        
        const defaultCronograma = {
            'Segunda': 'Direito Constitucional\nDireito Administrativo',
            'Ter√ßa': 'Direito Penal\nProcesso Penal',
            'Quarta': 'Legisla√ß√£o Especial\nInform√°tica',
            'Quinta': 'Direito Constitucional\nDireito Penal',
            'Sexta': 'Direito Administrativo\nProcesso Penal',
            'S√°bado': 'Revis√£o (Ciclo de Estudos)',
            'Domingo': ''
        };
        let cronograma = JSON.parse(localStorage.getItem('cronogramaPCPR')) || defaultCronograma;

        let timerInterval;
        let tempoRestante = pomodoroConfig.focus * 60; // Padr√£o Inicial
        let isRunning = false;
        let modoAtual = 'focus'; // focus, short, long
        let tempoTotalModoAtual = pomodoroConfig.focus * 60; // Para calcular progresso ou tempo decorrido

        // Auto-importa√ß√£o se vazio
        if (dados.length === 0) {
            dados = TODOS_EDITAIS.map((item, index) => {
                let link = LINKS_PADRAO[item.assunto] || "";
                return { ...item, id: Date.now() + index, tempo: 0, linkQuestao: link };
            });
            localStorage.setItem('dadosPCPR', JSON.stringify(dados));
        }

        const MATERIAS_DISPONIVEIS = [
            "L√≠ngua Portuguesa",
            "Inform√°tica",
            "Racioc√≠nio L√≥gico",
            "Direito Processual Penal",
            "Direito Penal",
            "Legisla√ß√£o Penal Especial",
            "Direito Administrativo",
            "Direito Constitucional",
            "Estrutura do Executivo PR",
            "Revis√£o (Ciclo de Estudos)",
            "Reda√ß√£o",
            "Simulado"
        ];

        // --- L√≥gica do Dark Mode ---
        function toggleTheme() {
            document.documentElement.classList.toggle('dark');
            const isDark = document.documentElement.classList.contains('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            updateThemeIcon();
        }

        function loadTheme() {
            const theme = localStorage.getItem('theme');
            if (theme === 'dark' || (!theme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
            updateThemeIcon();
        }

        function updateThemeIcon() {
            const btn = document.getElementById('btnThemeToggle');
            if (!btn) return;
            const isDark = document.documentElement.classList.contains('dark');
            btn.innerHTML = isDark ? '<i class="fas fa-sun text-yellow-400 text-xl"></i>' : '<i class="fas fa-moon text-gray-600 text-xl"></i>';
        }

        loadTheme();

        // --- POMODORO LOGIC ---
        
        function tocarAlarme() {
            try {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (!AudioContext) return;
                const ctx = new AudioContext();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                
                osc.connect(gain);
                gain.connect(ctx.destination);
                
                osc.type = 'sine';
                osc.frequency.setValueAtTime(880, ctx.currentTime); // A5
                osc.frequency.exponentialRampToValueAtTime(440, ctx.currentTime + 0.5); // A4
                
                gain.gain.setValueAtTime(0.3, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
                
                osc.start();
                osc.stop(ctx.currentTime + 0.5);
            } catch (e) {
                console.error("Audio error", e);
            }
        }

        function mudarModoPomodoro(modo) {
            if(isRunning) {
                if(!confirm("O timer est√° rodando. Deseja mudar de modo e perder o progresso?")) return;
                pausarTimer();
            }
            modoAtual = modo;
            
            // UI Updates
            document.getElementById('btnModeFocus').className = `px-3 py-1 rounded-full text-xs font-bold transition ${modo === 'focus' ? 'bg-green-600 text-white border border-green-500 shadow-lg transform scale-105' : 'bg-gray-700 text-gray-300 border border-gray-600 hover:bg-gray-600'}`;
            document.getElementById('btnModeShort').className = `px-3 py-1 rounded-full text-xs font-bold transition ${modo === 'short' ? 'bg-blue-600 text-white border border-blue-500 shadow-lg transform scale-105' : 'bg-gray-700 text-gray-300 border border-gray-600 hover:bg-gray-600'}`;
            document.getElementById('btnModeLong').className = `px-3 py-1 rounded-full text-xs font-bold transition ${modo === 'long' ? 'bg-purple-600 text-white border border-purple-500 shadow-lg transform scale-105' : 'bg-gray-700 text-gray-300 border border-gray-600 hover:bg-gray-600'}`;

            // Set time
            let minutos = 25;
            if (modo === 'focus') minutos = pomodoroConfig.focus;
            if (modo === 'short') minutos = pomodoroConfig.short;
            if (modo === 'long') minutos = pomodoroConfig.long;

            tempoRestante = minutos * 60;
            tempoTotalModoAtual = tempoRestante;
            atualizarDisplayTimer();
            
            // Status text
            const statusEl = document.getElementById('statusTimer');
            if(modo === 'focus') statusEl.innerText = "Hora de focar! Selecione uma mat√©ria.";
            else statusEl.innerText = "Hora de descansar.";
            
            // Disable subject select on breaks
            const select = document.getElementById('selectMateriaEstudo');
            if(modo !== 'focus') {
                select.disabled = true;
                select.value = "";
            } else {
                select.disabled = false;
            }
        }

        function abrirConfigPomodoro() {
            document.getElementById('cfgFocus').value = pomodoroConfig.focus;
            document.getElementById('cfgShort').value = pomodoroConfig.short;
            document.getElementById('cfgLong').value = pomodoroConfig.long;
            
            document.getElementById('modalPomodoroConfig').classList.remove('hidden');
            document.getElementById('modalMessage').classList.add('hidden');
            
            showModal("Configurar Pomodoro", "", "info", () => {
                const f = parseInt(document.getElementById('cfgFocus').value) || 25;
                const s = parseInt(document.getElementById('cfgShort').value) || 5;
                const l = parseInt(document.getElementById('cfgLong').value) || 15;
                
                pomodoroConfig = { focus: f, short: s, long: l };
                localStorage.setItem('pomodoroConfig', JSON.stringify(pomodoroConfig));
                mudarModoPomodoro(modoAtual); // Atualiza com novos valores
                showToast("Configura√ß√µes Salvas", "Timer atualizado.", "success");
            });
        }

        function atualizarDisplayTimer() {
            const m = Math.floor(tempoRestante / 60);
            const s = tempoRestante % 60;
            document.getElementById('displayTempo').innerText = `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        }

        function iniciarTimer() {
            const select = document.getElementById('selectMateriaEstudo');
            if(modoAtual === 'focus' && !select.value) { 
                showModal("Aten√ß√£o", "Selecione uma mat√©ria para focar!", "warning"); 
                return; 
            }
            
            if(isRunning) {
                pausarTimer();
                return;
            }

            isRunning = true;
            document.getElementById('iconPlayPause').className = 'fas fa-pause';
            document.getElementById('statusTimer').innerText = modoAtual === 'focus' ? "Focando..." : "Descansando...";
            if(modoAtual === 'focus') select.disabled = true;

            timerInterval = setInterval(() => {
                if(tempoRestante > 0) {
                    tempoRestante--;
                    atualizarDisplayTimer();
                } else {
                    timerFinalizado();
                }
            }, 1000);
        }

        function pausarTimer() {
            if(!isRunning) return;
            clearInterval(timerInterval);
            isRunning = false;
            document.getElementById('iconPlayPause').className = 'fas fa-play';
            document.getElementById('statusTimer').innerText = "Pausado";
        }

        function resetarTimer() {
            pausarTimer();
            mudarModoPomodoro(modoAtual);
        }

        function timerFinalizado() {
            pausarTimer();
            tocarAlarme();
            
            if(modoAtual === 'focus') {
                // Salvar tempo total do modo (j√° que completou)
                salvarTempoEstudado(tempoTotalModoAtual);
                showModal("Pomodoro Conclu√≠do!", "Parab√©ns! Tempo de foco registrado com sucesso. Hora de uma pausa?", "success", () => mudarModoPomodoro('short'));
            } else {
                showModal("Pausa Finalizada", "Hora de voltar ao trabalho?", "info", () => mudarModoPomodoro('focus'));
            }
        }

        function pararESalvar() {
            // Se estiver em modo foco e interromper, salvar o tempo decorrido
            if(modoAtual === 'focus') {
                const tempoDecorrido = tempoTotalModoAtual - tempoRestante;
                if(tempoDecorrido > 60) { // S√≥ salva se estudou mais de 1 minuto
                     salvarTempoEstudado(tempoDecorrido);
                     showModal("Interrompido", `Timer parado. ${Math.floor(tempoDecorrido/60)} minutos registrados.`, "info");
                } else {
                    showToast("Muito curto", "Menos de 1 min n√£o √© registrado.", "info");
                }
            }
            resetarTimer();
        }

        function salvarTempoEstudado(segundosEstudados) {
            const idSelecionado = parseInt(document.getElementById('selectMateriaEstudo').value);
            if(!idSelecionado) return;
            
            const index = dados.findIndex(i => i.id === idSelecionado);
            if(index !== -1) {
                dados[index].tempo += segundosEstudados;
                
                // Hist√≥rico
                historicoEstudos.push({
                    idMateria: idSelecionado,
                    data: new Date().toISOString().split('T')[0],
                    timestamp: Date.now(),
                    tempo: segundosEstudados,
                    revisado: false
                });
                
                localStorage.setItem('historicoEstudosPCPR', JSON.stringify(historicoEstudos));
                salvarDados();
            }
        }

        // --- Fun√ß√µes Auxiliares Gerais ---
        function verificarRevisoesDoDia() {
            const diasDaSemana = ['Domingo', 'Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta', 'S√°bado'];
            const hoje = new Date();
            const diaHojeStr = diasDaSemana[hoje.getDay()];
            document.getElementById('diaDaSemanaDisplay').innerText = diaHojeStr;

            const materiasHoje = cronograma[diaHojeStr] ? cronograma[diaHojeStr].split('\n') : [];
            const container = document.getElementById('cardAlertasRevisao');
            const lista = document.getElementById('listaRevisoesPendentes');
            const contador = document.getElementById('totalRevisoesPendentes');
            
            if(materiasHoje.length === 0) {
                container.classList.add('hidden');
                contador.innerText = "0";
                return;
            }

            const revisoesPendentes = historicoEstudos.filter(log => {
                const dataEstudo = new Date(log.data);
                const diffTime = Math.abs(hoje - dataEstudo);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                const itemDados = dados.find(d => d.id === log.idMateria);
                if (!itemDados) return false;
                const isMateriaDeHoje = materiasHoje.some(m => m === itemDados.materia);
                const naoEhHoje = diffDays > 0; 
                return !log.revisado && isMateriaDeHoje && naoEhHoje;
            });

            if (revisoesPendentes.length > 0) {
                container.classList.remove('hidden');
                container.classList.add('flex');
                lista.innerHTML = revisoesPendentes.map(log => {
                    const item = dados.find(i => i.id === log.idMateria);
                    const dataFormatada = new Date(log.data).toLocaleDateString('pt-BR');
                    const linkQuestao = item.linkQuestao;
                    const btnQuestao = linkQuestao ? `<a href="${linkQuestao}" target="_blank" class="text-blue-600 dark:text-blue-400 hover:underline text-xs mr-3"><i class="fas fa-external-link-alt"></i> Quest√µes</a>` : '';
                    return `
                        <div class="bg-white dark:bg-gray-700 p-3 rounded border border-yellow-200 dark:border-yellow-700 flex justify-between items-center shadow-sm">
                            <div>
                                <p class="font-bold text-gray-800 dark:text-gray-100 text-sm">${item.materia}</p>
                                <p class="text-xs text-gray-600 dark:text-gray-300">Assunto: <span class="font-semibold">${item.assunto}</span></p>
                                <p class="text-xs text-gray-400 mt-1">Estudado em: ${dataFormatada}</p>
                            </div>
                            <div class="flex flex-col items-end">
                                ${btnQuestao}
                                <button onclick="marcarComoRevisado(${log.timestamp})" class="mt-2 bg-green-100 dark:bg-green-800 text-green-700 dark:text-green-200 hover:bg-green-200 dark:hover:bg-green-700 px-3 py-1 rounded text-xs font-semibold transition"><i class="fas fa-check"></i> Concluir</button>
                            </div>
                        </div>`;
                }).join('');
                contador.innerText = revisoesPendentes.length;
            } else {
                container.classList.add('hidden');
                contador.innerText = "0";
            }
        }

        function marcarComoRevisado(timestampLog) {
            const index = historicoEstudos.findIndex(log => log.timestamp === timestampLog);
            if (index !== -1) {
                historicoEstudos[index].revisado = true;
                localStorage.setItem('historicoEstudosPCPR', JSON.stringify(historicoEstudos));
                renderizar(); 
                showToast("Revis√£o Conclu√≠da", "T√≥pico marcado como revisado!", "success");
            }
        }

        function salvarDados() { localStorage.setItem('dadosPCPR', JSON.stringify(dados)); renderizar(); }
        function salvarCronograma() { localStorage.setItem('cronogramaPCPR', JSON.stringify(cronograma)); renderizarCronograma(); verificarRevisoesDoDia(); }
        
        function adicionarMateriaCronograma(dia, materia) {
            if (!materia) return;
            const current = cronograma[dia] ? cronograma[dia].split('\n') : [];
            if (!current.includes(materia)) { current.push(materia); cronograma[dia] = current.filter(Boolean).join('\n'); salvarCronograma(); }
        }
        function removerMateriaCronograma(dia, materiaParaRemover) {
            const current = cronograma[dia] ? cronograma[dia].split('\n') : [];
            const novoArray = current.filter(m => m !== materiaParaRemover);
            cronograma[dia] = novoArray.join('\n'); salvarCronograma();
        }
        function resetarCronograma() { if(confirm("Deseja restaurar o cronograma padr√£o?")) { cronograma = {...defaultCronograma}; salvarCronograma(); } }

        function renderizarCronograma() {
            const grid = document.getElementById('gridCronograma');
            grid.innerHTML = '';
            const dias = ['Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta', 'S√°bado', 'Domingo'];
            dias.forEach(dia => {
                const listaMaterias = cronograma[dia] ? cronograma[dia].split('\n').filter(Boolean) : [];
                let bgClass = "bg-gray-50 border-gray-200 dark:bg-gray-700 dark:border-gray-600";
                if(dia === 'S√°bado') bgClass = "bg-blue-50 border-blue-200 dark:bg-blue-900/30 dark:border-blue-800";
                if(dia === 'Domingo') bgClass = "bg-red-50 border-red-200 dark:bg-red-900/30 dark:border-red-800";
                const div = document.createElement('div');
                div.className = `flex flex-col h-full border rounded p-2 ${bgClass} transition-colors duration-300`;
                div.innerHTML = `<div class="font-bold text-gray-700 dark:text-gray-200 text-sm mb-2 text-center">${dia}</div>`;
                const chipsContainer = document.createElement('div');
                chipsContainer.className = "flex-grow flex flex-col gap-1 mb-2";
                listaMaterias.forEach(materia => {
                    chipsContainer.innerHTML += `<div class="bg-white dark:bg-gray-600 border dark:border-gray-500 px-2 py-1 rounded text-xs flex justify-between items-center shadow-sm"><span class="truncate mr-1 text-gray-700 dark:text-gray-100 font-medium" title="${materia}">${materia}</span><button onclick="removerMateriaCronograma('${dia}', '${materia}')" class="text-red-400 hover:text-red-600 font-bold focus:outline-none">√ó</button></div>`;
                });
                div.appendChild(chipsContainer);
                const select = document.createElement('select');
                select.className = "w-full p-1 text-xs border rounded focus:outline-none focus:ring-1 focus:ring-blue-500 bg-white dark:bg-gray-700 dark:text-white dark:border-gray-600";
                select.innerHTML = `<option value="">+ Adicionar</option>` + MATERIAS_DISPONIVEIS.map(m => `<option value="${m}">${m}</option>`).join('');
                select.onchange = (e) => { adicionarMateriaCronograma(dia, e.target.value); e.target.value = ""; };
                div.appendChild(select);
                grid.appendChild(div);
            });
        }

        function atualizarRelevancia(id, novoValor) {
            let valor = parseInt(novoValor);
            if (isNaN(valor)) valor = 0; if (valor < 0) valor = 0; if (valor > 100) valor = 100;
            const index = dados.findIndex(i => i.id === id);
            if (index !== -1) { dados[index].relevancia = valor; salvarDados(); }
        }

        function confirmarDelecao(id) {
            showModal("Excluir Conte√∫do", "Tem certeza que deseja excluir este assunto?", "danger", () => {
                dados = dados.filter(item => item.id !== id);
                salvarDados();
                const select = document.getElementById('selectMateriaEstudo');
                if (select.value == id) resetarTimer();
            });
        }

        function formatarTempo(segundos) {
            const h = Math.floor(segundos / 3600);
            const m = Math.floor((segundos % 3600) / 60);
            const s = segundos % 60;
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        }

        function toggleGrupo(grupoId) {
            const linhas = document.querySelectorAll(`.${grupoId}`);
            linhas.forEach(linha => linha.classList.toggle('hidden'));
            const icon = document.getElementById(`icon-${grupoId}`);
            if(icon) {
                if(icon.classList.contains('fa-chevron-down')) { icon.classList.remove('fa-chevron-down'); icon.classList.add('fa-chevron-right'); } 
                else { icon.classList.remove('fa-chevron-right'); icon.classList.add('fa-chevron-down'); }
            }
        }

        function abrirEditorLink(id) {
            const item = dados.find(i => i.id === id);
            if (!item) return;
            const inputLink = document.getElementById('modalInputLink');
            inputLink.value = item.linkQuestao || "";
            document.getElementById('modalInputContainer').classList.remove('hidden');
            document.getElementById('modalPomodoroConfig').classList.add('hidden');
            document.getElementById('modalMessage').classList.remove('hidden');
            
            showModal("Gerenciar Link de Quest√µes", `Insira o link para o assunto: <b>${item.assunto}</b>`, "info", () => {
                const novoLink = inputLink.value.trim();
                const index = dados.findIndex(i => i.id === id);
                if(index !== -1) { dados[index].linkQuestao = novoLink; salvarDados(); }
            });
        }

        function encontrarJurisprudencia(materia, assunto) {
            const mapMateria = { "Direito Constitucional": "CONSTITUCIONAL", "Direito Administrativo": "ADMINISTRATIVO", "Direito Penal": "PENAL", "Direito Processual Penal": "PROCESSUAL", "Legisla√ß√£o Penal Especial": "LEGISLACAO", "Estrutura do Executivo PR": "ESTATUTO" };
            let categoria = mapMateria[materia];
            if (!categoria) {
                const termo = (materia + " " + assunto).toUpperCase();
                if (termo.includes("CONSTITUCIONAL") || termo.includes("DIREITOS FUNDAMENTAIS")) categoria = "CONSTITUCIONAL";
                else if (termo.includes("ADMINISTRATIVO") || termo.includes("ESTADO") || termo.includes("PODER")) categoria = "ADMINISTRATIVO";
                else if (termo.includes("PROCESSUAL") || termo.includes("INQU√âRITO") || termo.includes("PRIS√ÉO")) categoria = "PROCESSUAL";
                else if (termo.includes("PENAL") && !termo.includes("ESPECIAL")) categoria = "PENAL";
                else if (termo.includes("LEI") || termo.includes("ESTATUTO") || termo.includes("ESPECIAL")) categoria = "LEGISLACAO";
            }
            return categoria ? BANCO_JURISPRUDENCIA[categoria] : null;
        }

        function verJurisprudencia(categoria) {
            const juris = BANCO_JURISPRUDENCIA[categoria];
            if (!juris) return;
            const modalJuris = document.getElementById('modalJurisContent');
            document.getElementById('modalTitle').innerText = "Jurisprud√™ncia Relevante";
            document.getElementById('modalTitle').className = "text-lg font-bold text-indigo-700 dark:text-indigo-400";
            document.getElementById('modalMessage').innerHTML = ""; 
            document.getElementById('modalInputContainer').classList.add('hidden');
            document.getElementById('modalPomodoroConfig').classList.add('hidden');
            
            modalJuris.innerHTML = juris.map(decisao => `
                <div class="bg-indigo-50 dark:bg-indigo-900/30 border-l-4 border-indigo-500 p-3 rounded shadow-sm">
                    <div class="flex justify-between items-start mb-1"><span class="text-xs font-bold text-indigo-800 dark:text-indigo-300 bg-indigo-200 dark:bg-indigo-800 px-2 py-0.5 rounded">${decisao.p}</span></div>
                    <h4 class="text-sm font-bold text-gray-800 dark:text-gray-200 mb-1">${decisao.t}</h4><p class="text-xs text-gray-700 dark:text-gray-300 leading-relaxed">${decisao.r}</p>
                </div>`).join('');
            modalJuris.classList.remove('hidden');
            document.getElementById('modalButtons').innerHTML = `<button onclick="closeModal()" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 font-medium transition shadow-sm">Fechar</button>`;
            document.getElementById('customModal').classList.remove('hidden');
        }

        function renderizar() {
            renderizarCronograma();
            verificarRevisoesDoDia();
            const tbody = document.getElementById('tabelaCorpo');
            const select = document.getElementById('selectMateriaEstudo');
            const emptyState = document.getElementById('emptyState');
            tbody.innerHTML = '';
            
            if (dados.length === 0) { emptyState.classList.remove('hidden'); } else { emptyState.classList.add('hidden'); }
            
            const valorAtualSelect = select.value;
            // Preserva options se estiver rodando, senao recria
            if (!isRunning) { 
                select.innerHTML = '<option value="">Selecione o que vai estudar...</option>'; 
            } else {
                 // Mant√©m s√≥ o selecionado vis√≠vel ou todos mas disabled? Ja ta disabled no logic
            }

            let totalSegundosGeral = 0;
            const grupos = {};
            dados.forEach(item => {
                if (!grupos[item.materia]) { grupos[item.materia] = { itens: [], tempoTotalMateria: 0 }; }
                grupos[item.materia].itens.push(item);
                grupos[item.materia].tempoTotalMateria += item.tempo;
                totalSegundosGeral += item.tempo;
            });

            const materiasOrdenadas = Object.keys(grupos).sort();
            materiasOrdenadas.forEach((materia, idx) => {
                const grupo = grupos[materia];
                const grupoId = `grupo-${idx}`;
                const trHeader = document.createElement('tr');
                trHeader.className = "bg-gray-100 dark:bg-gray-700 border-b border-gray-200 dark:border-gray-600 cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-600 transition";
                trHeader.onclick = () => toggleGrupo(grupoId);
                trHeader.innerHTML = `
                    <td colspan="4" class="px-5 py-3">
                        <div class="flex items-center justify-between">
                            <span class="font-bold text-gray-800 dark:text-gray-200 text-lg flex items-center select-none"><i id="icon-${grupoId}" class="fas fa-chevron-down text-gray-500 mr-3 w-4"></i><i class="fas fa-folder-open text-blue-500 mr-2"></i> ${materia}</span>
                            <span class="text-xs font-semibold text-gray-500 dark:text-gray-400 bg-gray-200 dark:bg-gray-800 px-2 py-1 rounded">Total: ${formatarTempo(grupo.tempoTotalMateria)}</span>
                        </div>
                    </td>`;
                tbody.appendChild(trHeader);

                grupo.itens.forEach(item => {
                    const tr = document.createElement('tr');
                    tr.className = `${grupoId} hover:bg-gray-50 dark:hover:bg-gray-700 transition border-b border-gray-100 dark:border-gray-700 animate-fadeIn`;
                    let corBarra = item.relevancia > 75 ? 'bg-red-500' : (item.relevancia > 40 ? 'bg-yellow-500' : (item.relevancia == 0 ? 'bg-gray-300' : 'bg-green-500'));
                    const categoriaJuris = encontrarJurisprudencia(item.materia, item.assunto) ? Object.keys(BANCO_JURISPRUDENCIA).find(key => BANCO_JURISPRUDENCIA[key] === encontrarJurisprudencia(item.materia, item.assunto)) : null;
                    const jurisButton = categoriaJuris ? `<button onclick="verJurisprudencia('${categoriaJuris}')" class="text-xs text-indigo-600 dark:text-indigo-400 hover:text-indigo-800 font-semibold flex items-center transition hover:underline" title="Ver Jurisprud√™ncia"><i class="fas fa-gavel mr-1"></i> Juris</button>` : '';
                    const questaoButton = item.linkQuestao ? `<a href="${item.linkQuestao}" target="_blank" class="text-xs text-orange-600 dark:text-orange-400 hover:text-orange-800 font-semibold flex items-center transition hover:underline" title="Ir para Quest√µes"><i class="fas fa-pencil-alt mr-1"></i> Quest√µes</a>` : '';

                    tr.innerHTML = `
                        <td class="px-5 py-4 text-sm text-gray-600 dark:text-gray-300 pl-10 border-l-4 border-transparent hover:border-blue-300">
                            <div class="flex justify-between items-center"><span class="font-medium text-gray-700 dark:text-gray-200">${item.assunto}</span><div class="flex gap-2 ml-4"><button onclick="abrirEditorLink(${item.id})" class="text-gray-400 hover:text-blue-500 transition" title="Adicionar/Editar Link"><i class="fas fa-link"></i></button></div></div>
                            <div class="flex gap-3 mt-1">${jurisButton}${questaoButton}</div>
                        </td>
                        <td class="px-5 py-4 text-sm">
                            <div class="flex items-center gap-2">
                                <div class="relative">
                                    <input type="number" min="0" max="100" value="${item.relevancia}" onchange="atualizarRelevancia(${item.id}, this.value)" class="text-xs font-bold w-14 text-center border border-gray-300 dark:border-gray-600 rounded p-1 focus:border-blue-500 pr-4 bg-white dark:bg-gray-700 dark:text-white transition-colors duration-300">
                                    <span class="absolute right-1 top-1.5 text-xs text-gray-400 pointer-events-none">%</span>
                                </div>
                                <div class="w-full bg-gray-200 dark:bg-gray-600 rounded-full h-2"><div class="${corBarra} h-2 rounded-full transition-all duration-300" style="width: ${item.relevancia}%"></div></div>
                            </div>
                        </td>
                        <td class="px-5 py-4 text-sm font-mono text-gray-600 dark:text-gray-300"><span class="bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded border border-gray-200 dark:border-gray-600 transition-colors duration-300">${formatarTempo(item.tempo)}</span></td>
                        <td class="px-5 py-4 text-sm text-center"><button onclick="confirmarDelecao(${item.id})" class="text-red-500 hover:text-red-700 hover:bg-red-100 dark:hover:bg-red-900/30 p-2 rounded-full transition" title="Excluir"><i class="fas fa-trash"></i></button></td>`;
                    tbody.appendChild(tr);
                    if (!isRunning) { const option = document.createElement('option'); option.value = item.id; option.text = `${item.materia} > ${item.assunto}`; select.appendChild(option); }
                });
            });

            if (!isRunning && valorAtualSelect) { if ([...select.options].some(o => o.value == valorAtualSelect)) { select.value = valorAtualSelect; } }
            
            const totalAssuntosEl = document.getElementById('totalAssuntos');
            if (totalAssuntosEl) totalAssuntosEl.innerText = dados.length;

            const horasGeral = Math.floor(totalSegundosGeral / 3600);
            const minGeral = Math.floor((totalSegundosGeral % 3600) / 60);
            
            const totalHorasEl = document.getElementById('totalHoras');
            if(totalHorasEl) totalHorasEl.innerText = `${horasGeral}h ${minGeral}m`;
        }

        function showModal(title, message, type = "info", onConfirm = null) {
            const modal = document.getElementById('customModal');
            document.getElementById('modalTitle').innerText = title;
            // S√≥ esconde os espec√≠ficos se n√£o for config
            if(title !== "Configurar Pomodoro" && title !== "Jurisprud√™ncia Relevante") {
                document.getElementById('modalPomodoroConfig').classList.add('hidden');
                document.getElementById('modalInputContainer').classList.add('hidden');
                document.getElementById('modalJurisContent').classList.add('hidden');
                document.getElementById('modalMessage').classList.remove('hidden');
            }
            document.getElementById('modalMessage').innerHTML = message;

            const modalButtons = document.getElementById('modalButtons');
            modalButtons.innerHTML = '';
            
            const existingIcon = document.getElementById('modalHeader').querySelector('i');
            if(existingIcon) existingIcon.remove();
            let iconHtml = type === 'danger' ? '<i class="fas fa-exclamation-triangle text-red-500 text-xl"></i>' : (type === 'success' ? '<i class="fas fa-check-circle text-green-500 text-xl"></i>' : '<i class="fas fa-info-circle text-blue-500 text-xl"></i>');
            document.getElementById('modalHeader').insertAdjacentHTML('afterbegin', iconHtml);

            if (onConfirm) {
                modalButtons.innerHTML = `<button onclick="closeModal()" class="px-4 py-2 bg-white dark:bg-gray-700 text-gray-700 dark:text-white border dark:border-gray-600 rounded mr-2">Cancelar</button><button id="btnConfirm" class="px-4 py-2 bg-blue-600 text-white rounded">Confirmar</button>`;
                document.getElementById('btnConfirm').onclick = () => { onConfirm(); closeModal(); };
            } else {
                modalButtons.innerHTML = `<button onclick="closeModal()" class="px-4 py-2 bg-blue-600 text-white rounded">OK</button>`;
            }
            modal.classList.remove('hidden');
        }
        function closeModal() { document.getElementById('customModal').classList.add('hidden'); }
        function showToast(title, msg, type) { console.log(title, msg); }
        document.getElementById('customModal').addEventListener('click', function(e) { if (e.target === this) closeModal(); });

        renderizar();
        mudarModoPomodoro('focus'); // Init state
    </script>
</body>
</html>
